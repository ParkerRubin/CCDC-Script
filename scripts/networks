# 20_network_and_processes.ps1
# Read-only network + process snapshot (SAFE)

$stamp = Get-Date -Format "yyyyMMdd_HHmmss"
$base  = "C:\ProgramData\BlueTeam"
$logd  = Join-Path $base "logs"
New-Item -ItemType Directory -Force -Path $logd | Out-Null
$log   = Join-Path $logd "network_processes_$stamp.txt"

Start-Transcript -Path $log | Out-Null
Write-Host "=== NETWORK + PROCESS SNAPSHOT ===`n"

# IP configuration
Write-Host "[IP Configuration]"
ipconfig /all
Write-Host ""

# Listening ports
Write-Host "[Listening Ports]"
$ports = netstat -ano | Select-String "LISTENING"
$ports
Write-Host ""

# Map PID -> process info
Write-Host "[Port -> Process Mapping]"
$ports | ForEach-Object {
    $line = $_.ToString().Trim()
    $parts = $line -split "\s+"
    $pid = $parts[-1]

    $proc = Get-CimInstance Win32_Process -Filter "ProcessId=$pid" -ErrorAction SilentlyContinue
    if ($proc) {
        "{0,-6} {1}" -f $pid, $proc.ExecutablePath
    }
}
Write-Host ""

# Active network connections (optional but useful)
Write-Host "[Active Connections]"
netstat -ano | Select-String "ESTABLISHED"
Write-Host ""

Write-Host "=== SNAPSHOT COMPLETE ==="
Stop-Transcript | Out-Null
Write-Host "Log saved to $log"
